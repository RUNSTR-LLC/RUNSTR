<!DOCTYPE html>
<html>
<head>
    <title>Progressive Workout Loading - RUNSTR Diagnostic</title>
    <meta charset="utf-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; background: #0a0a0a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .controls { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .workout-list { background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #333; }
        .workout-item { background: #222; padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 4px solid #ff6600; }
        .workout-meta { font-size: 12px; color: #888; margin-top: 8px; }
        .relay-status { background: #111; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .relay-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .connected { background: #00ff88; }
        .connecting { background: #ffaa00; }
        .failed { background: #ff4444; }
        .success { color: #00ff88; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #66ccff; }
        button { background: #ff6600; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px; }
        button:hover { background: #ff8833; }
        button:disabled { background: #555; cursor: not-allowed; }
        input, textarea { padding: 10px; margin: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; }
        .log { background: #000; padding: 15px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-card { background: #222; padding: 15px; border-radius: 6px; text-align: center; flex: 1; }
        .stat-number { font-size: 24px; color: #ff6600; font-weight: bold; }
        .stat-label { font-size: 12px; color: #888; margin-top: 5px; }
        .load-more { background: #333; border: 1px solid #555; margin: 20px 0; padding: 15px; text-align: center; border-radius: 6px; }
        .time-filter { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
        .time-button { background: #333; border: 1px solid #555; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .time-button.active { background: #ff6600; border-color: #ff6600; }
        .progress-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ff6600, #ff8833); transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÉ‚Äç‚ôÇÔ∏è Progressive Workout Loading - RUNSTR Diagnostic</h1>
            <p style="color: #888;">Real-time workout history with progressive loading - workouts appear as each relay responds</p>
        </div>
        
        <div class="controls">
            <h3>üîë Authentication</h3>
            <p style="color: #ffaa00; font-size: 14px;">üîê Your keys stay in your browser - never sent anywhere</p>
            
            <div style="margin: 15px 0;">
                <label>Your Nsec (nsec1...): <input type="password" id="testNsec" placeholder="nsec1abc..." style="width: 400px;"></label><br>
                <small style="color: #888;">Or Pubkey (npub1...): <input type="text" id="testPubkey" value="npub1jdvvva54m8nchh3t708pav99qk24x6rkx2sh0e7jthh0l8efzt7q9y7jlj" style="width: 400px;"></small>
            </div>
            
            <div class="time-filter">
                <div class="time-button active" data-days="30">Last 30 Days</div>
                <div class="time-button" data-days="90">Last 3 Months</div>
                <div class="time-button" data-days="180">Last 6 Months</div>
                <div class="time-button" data-days="365">Last Year</div>
                <div class="time-button" data-days="0">All Time</div>
            </div>
            
            <div style="margin: 15px 0;">
                <label>Relay URLs:</label><br>
                <textarea id="relayUrls" style="width: 100%; height: 80px;">wss://relay.damus.io
wss://relay.primal.net
wss://nos.lol
wss://nostr.wine</textarea>
            </div>
            
            <button onclick="startProgressiveLoading()" id="startButton">üöÄ Start Progressive Loading</button>
            <button onclick="clearResults()" style="background: #666;">Clear Results</button>
            <button onclick="loadMoreWorkouts()" id="loadMoreButton" disabled>üì• Load More Workouts</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalWorkouts">0</div>
                <div class="stat-label">Total Workouts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="connectedRelays">0</div>
                <div class="stat-label">Connected Relays</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="loadTime">0s</div>
                <div class="stat-label">Load Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="eventsPerSecond">0</div>
                <div class="stat-label">Events/sec</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>

        <div class="relay-status">
            <h3>üì° Relay Connections</h3>
            <div id="relayStatuses"></div>
        </div>

        <div class="workout-list">
            <h3>üèÉ‚Äç‚ôÇÔ∏è Your Workout History <span id="workoutCount">(0 workouts)</span></h3>
            <div id="workoutResults">Click "Start Progressive Loading" to begin...</div>
        </div>

        <div class="load-more" id="loadMoreSection" style="display: none;">
            <button onclick="loadMoreWorkouts()" id="loadMoreButton2">üì• Load Older Workouts</button>
            <p style="color: #888; font-size: 12px; margin-top: 10px;">Currently showing recent workouts. Click to load older history.</p>
        </div>

        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #333;">
            <h3>üìä Debug Log</h3>
            <div id="debugLog" class="log">Waiting for test to start...</div>
        </div>
    </div>

    <script src="https://unpkg.com/nostr-tools@2.5.2/lib/nostr.bundle.js"></script>
    <script>
        let globalState = {
            pubkeyHex: null,
            relayConnections: new Map(),
            workouts: new Set(), // Use Set for deduplication
            loadedWorkouts: [],
            relayUrls: [],
            timeFilter: 30, // days
            startTime: null,
            progressInterval: null,
            totalExpectedRelays: 0,
            respondedRelays: 0,
            oldestTimestamp: null,
            isLoadingMore: false
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : '';
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearResults() {
            globalState.workouts = new Set();
            globalState.loadedWorkouts = [];
            globalState.relayConnections.clear();
            globalState.respondedRelays = 0;
            globalState.oldestTimestamp = null;
            
            document.getElementById('debugLog').innerHTML = 'Cleared results...\n';
            document.getElementById('workoutResults').innerHTML = 'Click "Start Progressive Loading" to begin...';
            document.getElementById('workoutCount').textContent = '(0 workouts)';
            document.getElementById('relayStatuses').innerHTML = '';
            document.getElementById('loadMoreSection').style.display = 'none';
            
            updateStats();
            updateProgress(0);
        }

        function updateStats() {
            document.getElementById('totalWorkouts').textContent = globalState.loadedWorkouts.length;
            document.getElementById('connectedRelays').textContent = Array.from(globalState.relayConnections.values()).filter(status => status === 'connected').length;
            
            const elapsed = globalState.startTime ? (Date.now() - globalState.startTime) / 1000 : 0;
            document.getElementById('loadTime').textContent = elapsed.toFixed(1) + 's';
            
            const eventsPerSec = elapsed > 0 ? (globalState.loadedWorkouts.length / elapsed).toFixed(1) : '0';
            document.getElementById('eventsPerSecond').textContent = eventsPerSec;
        }

        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function updateRelayStatus(relayUrl, status, message = '') {
            globalState.relayConnections.set(relayUrl, status);
            
            const statusesDiv = document.getElementById('relayStatuses');
            const relayId = relayUrl.replace(/[^a-zA-Z0-9]/g, '_');
            
            let relayDiv = document.getElementById('relay_' + relayId);
            if (!relayDiv) {
                relayDiv = document.createElement('div');
                relayDiv.id = 'relay_' + relayId;
                relayDiv.className = 'relay-item';
                statusesDiv.appendChild(relayDiv);
            }
            
            const statusClass = status === 'connected' ? 'connected' : status === 'failed' ? 'failed' : 'connecting';
            const statusText = status === 'connected' ? 'Connected' : status === 'failed' ? 'Failed' : 'Connecting...';
            
            relayDiv.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <div class="status-dot ${statusClass}"></div>
                    <span>${relayUrl}</span>
                </div>
                <div style="text-align: right;">
                    <span style="color: ${statusClass === 'connected' ? '#00ff88' : statusClass === 'failed' ? '#ff4444' : '#ffaa00'};">
                        ${statusText}
                    </span>
                    <br>
                    <small style="color: #888;">${message}</small>
                </div>
            `;
        }

        function addWorkoutToUI(event, relayUrl) {
            // Create unique ID for deduplication
            const workoutId = event.id;
            if (globalState.workouts.has(workoutId)) {
                return; // Already added
            }
            
            globalState.workouts.add(workoutId);
            
            // Parse workout data
            let workoutData;
            try {
                workoutData = JSON.parse(event.content);
            } catch (error) {
                // If content isn't JSON, create basic workout from tags
                workoutData = {
                    type: 'Workout',
                    duration: 0,
                    distance: 0
                };
            }
            
            // Extract data from tags
            const tags = event.tags || [];
            const duration = tags.find(t => t[0] === 'duration')?.[1] || workoutData.duration || 0;
            const distance = tags.find(t => t[0] === 'distance')?.[1] || workoutData.distance || 0;
            const activity = tags.find(t => t[0] === 'activity')?.[1] || workoutData.type || 'Workout';
            
            const workout = {
                id: workoutId,
                event,
                relayUrl,
                activity,
                duration: parseInt(duration) || 0,
                distance: parseFloat(distance) || 0,
                timestamp: event.created_at,
                content: workoutData
            };
            
            globalState.loadedWorkouts.push(workout);
            
            // Sort by timestamp (newest first)
            globalState.loadedWorkouts.sort((a, b) => b.timestamp - a.timestamp);
            
            // Track oldest timestamp for pagination
            if (!globalState.oldestTimestamp || event.created_at < globalState.oldestTimestamp) {
                globalState.oldestTimestamp = event.created_at;
            }
            
            renderWorkouts();
            updateStats();
            
            log(`üèÉ‚Äç‚ôÇÔ∏è Added ${activity} workout (${duration}min, ${distance.toFixed(1)}km) from ${relayUrl}`, 'success');
        }

        function renderWorkouts() {
            const resultsDiv = document.getElementById('workoutResults');
            const count = globalState.loadedWorkouts.length;
            
            document.getElementById('workoutCount').textContent = `(${count} workouts)`;
            
            if (count === 0) {
                resultsDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 40px;">No workouts found yet...</div>';
                return;
            }
            
            const html = globalState.loadedWorkouts.map(workout => {
                const date = new Date(workout.timestamp * 1000).toLocaleDateString();
                const time = new Date(workout.timestamp * 1000).toLocaleTimeString();
                const durationStr = workout.duration > 0 ? `${workout.duration}min` : '';
                const distanceStr = workout.distance > 0 ? `${workout.distance.toFixed(1)}km` : '';
                const stats = [durationStr, distanceStr].filter(s => s).join(' ‚Ä¢ ');
                
                return `
                    <div class="workout-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <strong>${workout.activity}</strong>
                                ${stats ? `<span style="color: #ff6600; margin-left: 10px;">${stats}</span>` : ''}
                            </div>
                            <div style="text-align: right; color: #888; font-size: 12px;">
                                ${date}<br>${time}
                            </div>
                        </div>
                        <div class="workout-meta">
                            Relay: ${workout.relayUrl} ‚Ä¢ Event ID: ${workout.id.substring(0, 16)}...
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = html;
            
            // Show load more button if we have workouts
            if (count > 0 && !globalState.isLoadingMore) {
                document.getElementById('loadMoreSection').style.display = 'block';
            }
        }

        // Time filter handling
        document.querySelectorAll('.time-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.time-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                globalState.timeFilter = parseInt(button.dataset.days);
                log(`‚è∞ Time filter changed to ${globalState.timeFilter === 0 ? 'All Time' : globalState.timeFilter + ' days'}`, 'info');
            });
        });

        async function startProgressiveLoading() {
            const startButton = document.getElementById('startButton');
            startButton.disabled = true;
            startButton.textContent = 'üîÑ Loading Progressively...';
            
            clearResults();
            globalState.startTime = Date.now();
            
            // Get user input
            const testNsec = document.getElementById('testNsec').value.trim();
            const testPubkey = document.getElementById('testPubkey').value.trim();
            const relayUrlsText = document.getElementById('relayUrls').value.trim();
            
            // Derive pubkey
            try {
                if (testNsec) {
                    const decoded = NostrTools.nip19.decode(testNsec);
                    if (decoded.type !== 'nsec') throw new Error('Invalid nsec format');
                    globalState.pubkeyHex = NostrTools.getPublicKey(decoded.data);
                    log(`üîë Nsec ‚Üí Pubkey: ${globalState.pubkeyHex.slice(0, 16)}...`, 'success');
                } else if (testPubkey) {
                    const decoded = NostrTools.nip19.decode(testPubkey);
                    globalState.pubkeyHex = decoded.data;
                    log(`‚úÖ Pubkey: ${globalState.pubkeyHex.slice(0, 16)}...`, 'success');
                } else {
                    throw new Error('Please enter your nsec or npub');
                }
            } catch (error) {
                log(`‚ùå Key error: ${error.message}`, 'error');
                startButton.disabled = false;
                startButton.textContent = 'üöÄ Start Progressive Loading';
                return;
            }
            
            globalState.relayUrls = relayUrlsText.split('\n').map(url => url.trim()).filter(url => url);
            globalState.totalExpectedRelays = globalState.relayUrls.length;
            
            log('üöÄ Starting Progressive Workout Loading', 'success');
            log(`üìã Config: ${globalState.relayUrls.length} relays, ${globalState.timeFilter === 0 ? 'All Time' : globalState.timeFilter + ' days'}`, 'info');
            log(`üéØ Target: Real-time updates as relays respond (no 30s wait)`, 'info');
            log('='.repeat(60), 'info');
            
            // Start progress animation
            globalState.progressInterval = setInterval(() => {
                const progressPercent = Math.min(95, (globalState.respondedRelays / globalState.totalExpectedRelays) * 100);
                updateProgress(progressPercent);
            }, 100);
            
            // Create time filter
            let sinceTimestamp = null;
            if (globalState.timeFilter > 0) {
                sinceTimestamp = Math.floor((Date.now() - globalState.timeFilter * 24 * 60 * 60 * 1000) / 1000);
                log(`üìÖ Time filter: Since ${new Date(sinceTimestamp * 1000).toLocaleDateString()}`, 'info');
            }
            
            // Start progressive loading from each relay
            const relayPromises = globalState.relayUrls.map(relayUrl => 
                loadFromRelay(relayUrl, sinceTimestamp)
            );
            
            // Wait for all relays to complete or timeout
            const timeout = setTimeout(() => {
                log('‚è∞ Progressive loading timeout reached', 'warning');
                completeProgressiveLoading();
            }, 10000); // 10 second total timeout
            
            try {
                await Promise.allSettled(relayPromises);
                clearTimeout(timeout);
                completeProgressiveLoading();
            } catch (error) {
                clearTimeout(timeout);
                log(`‚ùå Progressive loading error: ${error.message}`, 'error');
                completeProgressiveLoading();
            }
        }

        async function loadFromRelay(relayUrl, sinceTimestamp) {
            return new Promise((resolve) => {
                log(`üîå Connecting to ${relayUrl}...`, 'info');
                updateRelayStatus(relayUrl, 'connecting');
                
                const pool = new NostrTools.SimplePool();
                const startTime = Date.now();
                
                // Create filter
                const filter = {
                    kinds: [1301],
                    authors: [globalState.pubkeyHex],
                    limit: 100
                };
                
                if (sinceTimestamp) {
                    filter.since = sinceTimestamp;
                }
                
                // Set up timeout for this specific relay
                const relayTimeout = setTimeout(() => {
                    pool.close([relayUrl]);
                    updateRelayStatus(relayUrl, 'failed', 'Timeout (3s)');
                    globalState.respondedRelays++;
                    log(`‚è∞ ${relayUrl}: Timed out after 3s`, 'warning');
                    resolve();
                }, 3000);
                
                try {
                    // Use subscription for real-time updates
                    const sub = pool.subscribeMany([relayUrl], [filter], {
                        onevent: (event) => {
                            clearTimeout(relayTimeout);
                            const duration = Date.now() - startTime;
                            
                            if (globalState.relayConnections.get(relayUrl) !== 'connected') {
                                updateRelayStatus(relayUrl, 'connected', `${duration}ms`);
                                globalState.respondedRelays++;
                                log(`‚úÖ ${relayUrl}: Connected in ${duration}ms`, 'success');
                            }
                            
                            // Add workout immediately (progressive loading!)
                            addWorkoutToUI(event, relayUrl);
                        },
                        oneose: () => {
                            clearTimeout(relayTimeout);
                            const duration = Date.now() - startTime;
                            
                            if (globalState.relayConnections.get(relayUrl) !== 'connected') {
                                updateRelayStatus(relayUrl, 'connected', `EOSE ${duration}ms`);
                                globalState.respondedRelays++;
                                log(`üìù ${relayUrl}: EOSE in ${duration}ms`, 'info');
                            }
                            
                            // Close subscription after EOSE
                            setTimeout(() => {
                                sub.close();
                                pool.close([relayUrl]);
                                resolve();
                            }, 500);
                        },
                        onclose: () => {
                            clearTimeout(relayTimeout);
                            resolve();
                        }
                    });
                    
                } catch (error) {
                    clearTimeout(relayTimeout);
                    updateRelayStatus(relayUrl, 'failed', error.message);
                    globalState.respondedRelays++;
                    log(`‚ùå ${relayUrl}: ${error.message}`, 'error');
                    pool.close([relayUrl]);
                    resolve();
                }
            });
        }

        function completeProgressiveLoading() {
            const startButton = document.getElementById('startButton');
            startButton.disabled = false;
            startButton.textContent = 'üöÄ Start Progressive Loading';
            
            if (globalState.progressInterval) {
                clearInterval(globalState.progressInterval);
                globalState.progressInterval = null;
            }
            
            updateProgress(100);
            
            const totalTime = ((Date.now() - globalState.startTime) / 1000).toFixed(1);
            const connectedRelays = Array.from(globalState.relayConnections.values()).filter(status => status === 'connected').length;
            
            log('='.repeat(60), 'info');
            log('üìä PROGRESSIVE LOADING COMPLETE', 'success');
            log(`‚è∞ Total Time: ${totalTime}s (target: <5s)`, connectedRelays > 0 ? 'success' : 'warning');
            log(`üì° Connected Relays: ${connectedRelays}/${globalState.totalExpectedRelays}`, connectedRelays > 0 ? 'success' : 'warning');
            log(`üèÉ‚Äç‚ôÇÔ∏è Workouts Found: ${globalState.loadedWorkouts.length}`, globalState.loadedWorkouts.length > 0 ? 'success' : 'warning');
            
            if (globalState.loadedWorkouts.length === 0) {
                log('‚ùå NO WORKOUTS FOUND - Check your pubkey or publish some 1301 events first', 'error');
                document.getElementById('workoutResults').innerHTML = `
                    <div style="color: #ff4444; text-align: center; padding: 40px;">
                        <h4>No 1301 workout events found</h4>
                        <p>This could mean:</p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>You haven't published any kind 1301 workout events yet</li>
                            <li>The pubkey doesn't match your publishing key</li>
                            <li>Your events are older than the time filter (${globalState.timeFilter} days)</li>
                            <li>Relays don't have your events indexed yet</li>
                        </ul>
                        <p style="color: #888;">Try changing the time filter to "All Time" or check your pubkey.</p>
                    </div>
                `;
            } else {
                log('‚úÖ SUCCESS: Progressive loading working correctly!', 'success');
                log(`üí° This proves the query logic works - apply to React Native`, 'info');
            }
        }

        async function loadMoreWorkouts() {
            if (globalState.isLoadingMore || !globalState.oldestTimestamp) {
                return;
            }
            
            globalState.isLoadingMore = true;
            const loadMoreButton = document.getElementById('loadMoreButton');
            const loadMoreButton2 = document.getElementById('loadMoreButton2');
            
            [loadMoreButton, loadMoreButton2].forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'üîÑ Loading More...';
            });
            
            log('üì• Loading older workouts...', 'info');
            
            const relayPromises = globalState.relayUrls.map(relayUrl => 
                loadOlderFromRelay(relayUrl, globalState.oldestTimestamp - 1)
            );
            
            await Promise.allSettled(relayPromises);
            
            globalState.isLoadingMore = false;
            [loadMoreButton, loadMoreButton2].forEach(btn => {
                btn.disabled = false;
                btn.textContent = 'üì• Load More Workouts';
            });
            
            log('‚úÖ Finished loading older workouts', 'success');
        }

        async function loadOlderFromRelay(relayUrl, untilTimestamp) {
            return new Promise((resolve) => {
                const pool = new NostrTools.SimplePool();
                
                const filter = {
                    kinds: [1301],
                    authors: [globalState.pubkeyHex],
                    until: untilTimestamp,
                    limit: 50
                };
                
                const timeout = setTimeout(() => {
                    pool.close([relayUrl]);
                    resolve();
                }, 3000);
                
                try {
                    const sub = pool.subscribeMany([relayUrl], [filter], {
                        onevent: (event) => {
                            addWorkoutToUI(event, relayUrl);
                        },
                        oneose: () => {
                            clearTimeout(timeout);
                            sub.close();
                            pool.close([relayUrl]);
                            resolve();
                        }
                    });
                } catch (error) {
                    clearTimeout(timeout);
                    pool.close([relayUrl]);
                    resolve();
                }
            });
        }

        // Initialize
        log('üöÄ Progressive Workout Loading Test Ready', 'info');
        log('Enter your nsec/npub above and click "Start Progressive Loading"', 'info');
    </script>
</body>
</html>